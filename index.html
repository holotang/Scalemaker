<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sonata Composer Studio [Note Selector Edition]</title>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background: #f0f2f5; color: #333; margin: 0; padding: 0; line-height: 1.6; }
        header { background: #1a1a1a; color: white; padding: 1rem; text-align: center; }
        h1 { margin: 0; font-size: 1.5rem; letter-spacing: 2px; }
        main { max-width: 1450px; margin: 1.5rem auto; padding: 0 1rem; }
        .section-box { background: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h2 { font-size: 1.1rem; border-left: 4px solid #e63946; padding-left: 10px; margin-bottom: 15px; }
        
        /* ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç† */
        .project-manager { display: flex; gap: 10px; align-items: center; background: #333; color: white; padding: 10px 20px; border-radius: 8px; margin-bottom: 1rem; flex-wrap: wrap; }
        .project-btn { background: #555; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; border: none; font-size: 0.8rem; }
        
        /* æ¥½æ›²æ§‹æˆï¼ˆæœ€ä¸Šæ®µï¼‰ */
        .timeline-header { display: grid; grid-template-columns: 80px 80px 150px 180px 1fr 80px 40px; gap: 10px; padding: 10px; font-weight: bold; font-size: 0.8rem; border-bottom: 2px solid #eee; }
        .timeline-item { display: grid; grid-template-columns: 80px 80px 150px 180px 1fr 80px 40px; gap: 10px; align-items: center; background: #f8f9fa; padding: 10px; border-radius: 6px; border: 1px solid #ddd; margin-top: 5px; }
        .timeline-item input, .timeline-item select { padding: 5px; border-radius: 4px; border: 1px solid #ccc; font-size: 0.9rem; width: 100%; }
        .total-info { background: #e63946; color: #fff; padding: 10px 20px; border-radius: 8px; font-weight: bold; font-size: 1.1rem; display: inline-block; margin-top: 10px; }
        
        /* 12éŸ³ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ */
        .converter-grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 8px; margin-bottom: 15px; background: #f8f9fa; padding: 15px; border-radius: 8px; }
        .converter-input label { display: block; font-size: 0.65rem; color: #666; text-align: center; }
        .converter-input select { width: 100%; padding: 5px; border-radius: 4px; border: 1px solid #ccc; font-weight: bold; font-size: 0.8rem; background-color: #fff; cursor: pointer; }

        /* ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º */
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; font-size: 0.85rem; }
        th { background: #333; color: white; padding: 10px; text-align: left; }
        td { padding: 8px 10px; border-bottom: 1px solid #eee; }
        .notes-text { font-family: 'Courier New', monospace; font-weight: bold; font-size: 1rem; }
        
        /* éŸ³ã®è‰²åˆ†ã‘ */
        .in-scale { color: #2a9d8f; } /* ã‚¹ã‚±ãƒ¼ãƒ«å†… */
        .out-scale { color: #f4a261; font-weight: normal; opacity: 0.7; } /* ã‚¹ã‚±ãƒ¼ãƒ«å¤– */
        .chord-notes { color: #e63946; } /* 3åº¦æ§‹æˆ */
        
        .add-btn { background: #2a9d8f; color: white; padding: 8px 15px; border:none; border-radius:4px; font-weight:bold; cursor:pointer; margin-top:10px; }
        .del-btn { background: #ccc; color: white; border:none; border-radius:4px; cursor:pointer; height: 30px; }
        .del-btn:hover { background: #e63946; }
    </style>
</head>
<body>

<header><h1>ğŸ¼ Sonata Composer Studio</h1></header>

<main>
    <div class="project-manager">
        <label>ğŸ“ æ›²ã‚’é¸æŠ:</label>
        <select id="projectList" onchange="switchProject()"></select>
        <button class="project-btn" onclick="createNewProject()">ï¼‹ æ–°è¦ä½œæˆ</button>
        <button class="project-btn" onclick="renameProject()">âœï¸ åå‰å¤‰æ›´</button>
        <div id="saveStatus" style="margin-left:auto; font-size:0.8rem; color:#2a9d8f;">è‡ªå‹•ä¿å­˜ä¸­</div>
    </div>

    <div class="section-box">
        <h2>æ¥½æ›²æ§‹æˆ & æ¼”å¥æ™‚é–“è¨­è¨ˆ (Time & Form)</h2>
        <div class="timeline-header">
            <div>å°ç¯€æ•°</div><div>BPM</div><div>ã‚»ã‚¯ã‚·ãƒ§ãƒ³</div><div>ã‚¹ã‚±ãƒ¼ãƒ«</div><div>ãƒ¡ãƒ¢</div><div>æ™‚é–“</div><div></div>
        </div>
        <div id="timeline"></div>
        <button class="add-btn" onclick="addTimelineRow(); saveToLocal();">ï¼‹ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ </button>
        <br>
        <div id="totalDisplay" class="total-info">ç·æ¼”å¥æ™‚é–“: 0åˆ† 0ç§’</div>
    </div>

    <div class="section-box">
        <h2>ãƒ¡ãƒ­ãƒ‡ã‚£å¤‰æ› (Chromatic Note Selector)</h2>
        <div class="converter-grid" id="inputGrid"></div>
        <p style="font-size: 0.75rem; color: #666;">â€»ç·‘ï¼ã‚¹ã‚±ãƒ¼ãƒ«å†…ã€ã‚ªãƒ¬ãƒ³ã‚¸ï¼ã‚¹ã‚±ãƒ¼ãƒ«å¤–ã€‚Keyã«åˆã‚ã›ã¦è‡ªå‹•ç§»èª¿ã•ã‚Œã¾ã™ã€‚</p>
    </div>

    <div class="section-box">
        <h2>ã‚¹ã‚±ãƒ¼ãƒ«ãƒ»ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ (Matrix)</h2>
        <div style="margin-bottom:15px; display:flex; gap:20px; align-items:center;">
            <label>Root Key: <select id="keySelect" onchange="update()"></select></label>
        </div>
        <div id="checkboxContainer" style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:15px;"></div>
        <table>
            <thead>
                <tr>
                    <th style="width:120px;">ã‚¹ã‚±ãƒ¼ãƒ«å</th>
                    <th>å¤‰æ›çµæœ</th>
                    <th>éŸ³éšé † (Scale)</th>
                    <th>3åº¦é † (Chord)</th>
                    <th>åœ°åŸŸ/ã‚¤ãƒ¡ãƒ¼ã‚¸</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</main>

<script>
    const notesSharp = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
    const notesFlat  = ["C", "Db", "D", "Eb", "E", "F", "Gb", "G", "Ab", "A", "Bb", "B"];
    function n(name) { const idx = notesFlat.indexOf(name); return idx !== -1 ? idx : notesSharp.indexOf(name); }

    const scales = [
        { id: "ryukyu", name: "ç‰çƒéŸ³éš", notes: ["C", "E", "F", "G", "B"], img: "æ²–ç¸„/å¤ªé™½", pref: "sharp" },
        { id: "ritsu", name: "å¾‹æ—‹æ³•", notes: ["C", "D", "F", "G", "A"], img: "é›…æ¥½/é™è¬", pref: "sharp" },
        { id: "in", name: "é™°æ—‹æ³•", notes: ["C", "Db", "F", "G", "Ab"], img: "éƒ½ç¯€/å“€æ„", pref: "flat" },
        { id: "china", name: "ä¸­å›½éŸ³éš", notes: ["C", "D", "F", "G", "A"], img: "ä¸­å›½/æ‚ ä¹…", pref: "sharp" },
        { id: "whole", name: "å…¨éŸ³éŸ³éš", notes: ["C", "D", "E", "Gb", "Ab", "Bb"], img: "ä»/å¤¢å¹»", pref: "sharp" },
        { id: "mystic", name: "ç¥ç§˜éŸ³éš", notes: ["C", "D", "E", "Gb", "A", "Bb"], img: "éœ²/æ³•æ‚¦", pref: "sharp" },
        { id: "ionian", name: "ã‚¢ã‚¤ã‚ªãƒ‹ã‚¢ãƒ³", notes: ["C", "D", "E", "F", "G", "A", "B"], img: "é•·éŸ³éš", pref: "sharp" },
        { id: "lydian", name: "ãƒªãƒ‡ã‚£ã‚¢ãƒ³", notes: ["C", "D", "E", "F#", "G", "A", "B"], img: "æµ®éŠæ„Ÿ", pref: "sharp" },
        { id: "mixo", name: "ãƒŸã‚¯ã‚½ãƒªãƒ‡ã‚£ã‚¢ãƒ³", notes: ["C", "D", "E", "F", "G", "A", "Bb"], img: "ç¥ç¥­", pref: "flat" },
        { id: "phrygian_dom", name: "ãƒ•ãƒªã‚¸ã‚¢ãƒ³Dom", notes: ["C", "Db", "E", "F", "G", "Ab", "Bb"], img: "ã‚¨ã‚¸ãƒ—ãƒˆ", pref: "flat" },
        { id: "dim_hw", name: "åŠå…¨ãƒ‡ã‚£ãƒŸãƒ‹ãƒƒã‚·ãƒ¥", notes: ["C", "Db", "Eb", "E", "Gb", "G", "A", "Bb"], img: "ãƒ¡ã‚·ã‚¢ãƒ³2", pref: "flat" },
        { id: "dim_wh", name: "å…¨åŠãƒ‡ã‚£ãƒŸãƒ‹ãƒƒã‚·ãƒ¥", notes: ["C", "D", "Eb", "F", "Gb", "Ab", "A", "B"], img: "ç¡¬è³ª", pref: "sharp" },
        { id: "bebop_dom", name: "ãƒ“ãƒãƒƒãƒ—Dom", notes: ["C", "D", "E", "F", "G", "A", "Bb", "B"], img: "Jazz", pref: "flat" },
        { id: "messiaen3", name: "ãƒ¡ã‚·ã‚¢ãƒ³ç¬¬3", notes: ["C", "D", "Eb", "E", "F#", "G", "Ab", "Bb", "B"], img: "è‰²å½©", pref: "sharp" },
        { id: "messiaen7", name: "ãƒ¡ã‚·ã‚¢ãƒ³ç¬¬7", notes: ["C", "Db", "D", "Eb", "F", "Gb", "G", "Ab", "A", "B"], img: "ã‚«ã‚ªã‚¹", pref: "sharp" },
        { id: "spiral", name: "èºæ—‹éŸ³éš", notes: ["C", "D", "E", "Gb", "Ab", "Bb", "C#", "D#", "F", "G", "A", "B"], img: "ç„¡é™", pref: "sharp" }
    ];

    let currentProjectName = "My Sonata";
    let allProjects = { "My Sonata": [] };

    // 12éŸ³å…¥åŠ›æ ï¼ˆéŸ³åãƒ™ãƒ¼ã‚¹ï¼‰ç”Ÿæˆ
    const inputGrid = document.getElementById('inputGrid');
    for(let i=1; i<=12; i++) {
        inputGrid.innerHTML += `
            <div class="converter-input">
                <label>${i}</label>
                <select class="deg-in" onchange="update()">
                    <option value="-1">-</option>
                    ${notesFlat.map((name, idx) => `<option value="${idx}">${name}</option>`).join('')}
                </select>
            </div>`;
    }

    function calculateTotal() {
        let totalSec = 0;
        document.querySelectorAll('.timeline-item').forEach(item => {
            const bars = parseFloat(item.querySelector('.input-bars').value) || 0;
            const bpm = parseFloat(item.querySelector('.input-bpm').value) || 120;
            const sec = (bars * 4) * (60 / bpm);
            item.querySelector('.duration-cell').innerText = Math.round(sec) + "s";
            totalSec += sec;
        });
        const m = Math.floor(totalSec / 60); const s = Math.round(totalSec % 60);
        document.getElementById('totalDisplay').innerText = `ç·æ¼”å¥æ™‚é–“: ${m}åˆ† ${s}ç§’`;
    }

    function saveToLocal() {
        const data = [];
        document.querySelectorAll('.timeline-item').forEach(item => {
            data.push({ bars: item.querySelector('.input-bars').value, bpm: item.querySelector('.input-bpm').value, secName: item.querySelector('.input-sec').value, scale: item.querySelector('.select-scale').value, memo: item.querySelector('.input-memo').value });
        });
        allProjects[currentProjectName] = data;
        localStorage.setItem('sonataNoteFinal', JSON.stringify(allProjects));
        localStorage.setItem('lastProjNote', currentProjectName);
        document.getElementById('saveStatus').innerText = "ä¿å­˜æ¸ˆã¿ " + new Date().toLocaleTimeString();
    }

    function addTimelineRow(bars="32", bpm="120", secName="", scaleName="ç‰çƒéŸ³éš", memo="") {
        const container = document.getElementById('timeline');
        const div = document.createElement('div');
        div.className = 'timeline-item';
        div.innerHTML = `<input type="number" class="input-bars" value="${bars}" oninput="calculateTotal(); saveToLocal();"> <input type="number" class="input-bpm" value="${bpm}" oninput="calculateTotal(); saveToLocal();"> <input type="text" class="input-sec" value="${secName}" oninput="saveToLocal();"> <select class="select-scale" onchange="saveToLocal();">${scales.map(s => `<option ${s.name===scaleName?'selected':''}>${s.name}</option>`).join('')}</select> <input type="text" class="input-memo" value="${memo}" oninput="saveToLocal();"> <div class="duration-cell">0s</div> <button class="del-btn" onclick="this.parentElement.remove(); calculateTotal(); saveToLocal();">Ã—</button>`;
        container.appendChild(div); calculateTotal();
    }

    function switchProject() {
        currentProjectName = document.getElementById('projectList').value;
        document.getElementById('timeline').innerHTML = "";
        const data = allProjects[currentProjectName];
        if (data && data.length > 0) data.forEach(d => addTimelineRow(d.bars, d.bpm, d.secName, d.scale, d.memo));
        else addTimelineRow("64", "120", "æç¤ºéƒ¨", "ç‰çƒéŸ³éš", "");
        calculateTotal();
    }

    function createNewProject() {
        const name = prompt("æ›²å:");
        if (name && !allProjects[name]) { allProjects[name] = []; currentProjectName = name; renderProjectList(); switchProject(); saveToLocal(); }
    }

    function renameProject() {
        const newName = prompt("åå‰å¤‰æ›´:", currentProjectName);
        if (newName && newName !== currentProjectName) {
            allProjects[newName] = allProjects[currentProjectName]; delete allProjects[currentProjectName];
            currentProjectName = newName; renderProjectList(); saveToLocal();
        }
    }

    function renderProjectList() {
        const list = document.getElementById('projectList'); list.innerHTML = "";
        Object.keys(allProjects).forEach(name => { const opt = document.createElement('option'); opt.value = name; opt.textContent = name; if (name === currentProjectName) opt.selected = true; list.appendChild(opt); });
    }

    const keySelect = document.getElementById('keySelect');
    notesFlat.forEach((n, i) => { const opt = document.createElement('option'); opt.value = i; opt.textContent = n; keySelect.appendChild(opt); });
    const checkboxContainer = document.getElementById('checkboxContainer');
    scales.forEach(s => { checkboxContainer.innerHTML += `<label style="font-size:0.7rem; background:#eee; padding:2px 8px; border-radius:10px; cursor:pointer;"><input type="checkbox" id="check_${s.id}" checked onchange="update()"> ${s.name}</label>`; });

    function update() {
        const shift = parseInt(keySelect.value);
        const tbody = document.getElementById('tableBody');
        const degInputs = Array.from(document.querySelectorAll('.deg-in')).map(s => parseInt(s.value));
        const isFlat = [1, 3, 5, 8, 10].includes(shift);
        tbody.innerHTML = "";

        scales.forEach(s => {
            if (!document.getElementById(`check_${s.id}`).checked) return;
            const noteList = (s.pref === "flat") || (isFlat && s.pref !== "sharp") ? notesFlat : notesSharp;
            const intervals = s.notes.map(name => n(name));
            
            // å¤‰æ›ãƒ¡ãƒ­ãƒ‡ã‚£ (å…¥åŠ›ã•ã‚ŒãŸéŸ³ã‚’ç§»èª¿)
            const convertedHTML = degInputs.filter(v => v !== -1).map(v => {
                const transposedIdx = (v + shift) % 12;
                const noteName = noteList[transposedIdx];
                const isInScale = intervals.includes(v); // å…¥åŠ›éŸ³(CåŸºæº–)ãŒã‚¹ã‚±ãƒ¼ãƒ«å®šç¾©(CåŸºæº–)ã«ã‚ã‚‹ã‹
                return `<span class="${isInScale ? 'in-scale' : 'out-scale'}">${noteName}</span>`;
            }).join(" ");

            const scaleNotes = intervals.map(i => noteList[(i + shift) % 12]).join(" ");
            let tertial = []; let temp = [...intervals]; let i = 0;
            while (temp.length > 0) { tertial.push(temp[i]); temp.splice(i, 1); if (temp.length > 0) i = (i + 1) % temp.length; }
            const chordNotes = tertial.map(i => noteList[(i + shift) % 12]).join(" ");

            tbody.innerHTML += `<tr><td style="font-weight:bold;">${s.name}</td><td class="notes-text">${convertedHTML}</td><td class="notes-text">${scaleNotes}</td><td class="notes-text chord-notes">${chordNotes}</td><td><span style="font-size:0.7rem;">${s.img}</span></td></tr>`;
        });
    }

    window.onload = () => {
        const saved = localStorage.getItem('sonataNoteFinal');
        const last = localStorage.getItem('lastProjNote');
        if (saved) { allProjects = JSON.parse(saved); if (last) currentProjectName = last; }
        renderProjectList(); switchProject(); update();
    };
</script>
</body>
</html>

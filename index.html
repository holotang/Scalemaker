<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sonata Composer Studio [Full Suite]</title>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background: #f0f2f5; color: #333; margin: 0; padding: 0; line-height: 1.6; }
        header { background: #1a1a1a; color: white; padding: 1rem; text-align: center; }
        h1 { margin: 0; font-size: 1.5rem; letter-spacing: 2px; }
        main { max-width: 1250px; margin: 1.5rem auto; padding: 0 1rem; }
        .section-box { background: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h2 { font-size: 1.1rem; border-left: 4px solid #e63946; padding-left: 10px; margin-top: 0; display: flex; justify-content: space-between; align-items: center; }
        .project-manager { display: flex; gap: 10px; align-items: center; background: #333; color: white; padding: 10px 20px; border-radius: 8px; margin-bottom: 1rem; flex-wrap: wrap; }
        .project-manager select { padding: 5px 10px; border-radius: 4px; font-size: 0.9rem; }
        .project-btn { background: #555; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; border: none; font-size: 0.8rem; }
        .timeline-header { display: grid; grid-template-columns: 80px 80px 150px 180px 1fr 80px 40px; gap: 10px; padding: 10px; font-weight: bold; font-size: 0.8rem; border-bottom: 2px solid #eee; }
        .timeline-item { display: grid; grid-template-columns: 80px 80px 150px 180px 1fr 80px 40px; gap: 10px; align-items: center; background: #f8f9fa; padding: 10px; border-radius: 6px; border: 1px solid #ddd; margin-top: 5px; }
        .timeline-item input, .timeline-item select { padding: 5px; border-radius: 4px; border: 1px solid #ccc; font-size: 0.9rem; width: 100%; box-sizing: border-box; }
        .total-info { background: #e63946; color: #fff; padding: 10px 20px; border-radius: 8px; font-weight: bold; font-size: 1.1rem; display: inline-block; margin-top: 10px; }
        .duration-cell { font-weight: bold; color: #2a9d8f; text-align: center; }
        .notes-text { font-family: 'Courier New', monospace; font-weight: bold; color: #e63946; font-size: 1rem; }
        button.add-btn { background: #2a9d8f; color: white; padding: 8px 15px; margin-top: 15px; border:none; border-radius:4px; font-weight:bold; cursor:pointer;}
        .del-btn { background: #ccc; color: white; border:none; border-radius:4px; cursor:pointer; height: 30px; }
        .del-btn:hover { background: #e63946; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; font-size: 0.85rem; }
        th { background: #333; color: white; padding: 10px; text-align: left; }
        td { padding: 8px 10px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

<header><h1>ğŸ¼ Sonata Composer Studio</h1></header>

<main>
    <div class="project-manager">
        <label>ğŸ“ æ›²ã‚’é¸æŠ:</label>
        <select id="projectList" onchange="switchProject()"></select>
        <button class="project-btn" onclick="createNewProject()">ï¼‹ æ–°è¦ä½œæˆ</button>
        <button class="project-btn" onclick="renameProject()">âœï¸ åå‰å¤‰æ›´</button>
        <button class="project-btn" style="background:#822;" onclick="deleteProject()">ğŸ—‘ï¸ å‰Šé™¤</button>
        <div id="saveStatus" style="margin-left:auto; font-size:0.8rem; color:#2a9d8f;">ä¿å­˜æ¸ˆã¿</div>
    </div>

    <div class="section-box">
        <h2>æ¥½æ›²æ§‹æˆ & æ¼”å¥æ™‚é–“è¨­è¨ˆ</h2>
        <div class="timeline-header">
            <div>å°ç¯€æ•°</div><div>BPM</div><div>ã‚»ã‚¯ã‚·ãƒ§ãƒ³</div><div>ä½¿ç”¨ã‚¹ã‚±ãƒ¼ãƒ«</div><div>ãƒ¡ãƒ¢</div><div>æ™‚é–“</div><div></div>
        </div>
        <div id="timeline"></div>
        <button class="add-btn" onclick="addTimelineRow(); saveToLocal();">ï¼‹ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ </button>
        <br>
        <div id="totalDisplay" class="total-info">ç·æ¼”å¥æ™‚é–“: 0åˆ† 0ç§’</div>
    </div>

    <div class="section-box">
        <h2>ã‚¹ã‚±ãƒ¼ãƒ«ãƒ»ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ (å…¨31ç¨®)</h2>
        <div style="margin-bottom:15px; display:flex; gap:20px; align-items:center; flex-wrap:wrap;">
            <label>Root Key: <select id="keySelect" onchange="update()"></select></label>
            <label>ä¸¦ã³é †: <select id="orderSelect" onchange="update()">
                <option value="scale">éŸ³éšé †</option><option value="tertial">3åº¦æ§‹æˆé †</option>
            </select></label>
        </div>
        <div id="checkboxContainer" style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:15px;"></div>
        <table>
            <thead><tr><th>éŸ³æ•°</th><th>ã‚¹ã‚±ãƒ¼ãƒ«å</th><th>æ§‹æˆéŸ³</th><th>åœ°åŸŸ</th><th>ã‚¤ãƒ¡ãƒ¼ã‚¸</th></tr></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</main>

<script>
    const notesSharp = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
    const notesFlat  = ["C", "Db", "D", "Eb", "E", "F", "Gb", "G", "Ab", "A", "Bb", "B"];
    
    // å…¨ã‚¹ã‚±ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨å¾©å…ƒ
    const scales = [
        { id: "ryukyu", n: 5, name: "ç‰çƒéŸ³éš", intervals: [0, 4, 5, 7, 11], region: "æ²–ç¸„", img: "å¤ªé™½", prefer: "sharp" },
        { id: "ritsu", n: 5, name: "å¾‹æ—‹æ³•", intervals: [0, 2, 5, 7, 9], region: "é›…æ¥½", img: "é™è¬", prefer: "sharp" },
        { id: "in", n: 5, name: "é™°æ—‹æ³•", intervals: [0, 1, 5, 7, 8], region: "éƒ½ç¯€", img: "å“€æ„", prefer: "flat" },
        { id: "china", n: 5, name: "ä¸­å›½éŸ³éš", intervals: [0, 2, 4, 7, 9], region: "ä¸­å›½", img: "æ‚ ä¹…", prefer: "sharp" },
        { id: "persia", n: 5, name: "ãƒšãƒ«ã‚·ãƒ£", intervals: [0, 1, 4, 7, 8], region: "ä¸­æ±", img: "å‘ªè¡“çš„", prefer: "flat" },
        { id: "java", n: 5, name: "ã‚¸ãƒ£ãƒãƒ‹ãƒ¼ã‚º", intervals: [0, 1, 3, 7, 8], region: "ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢", img: "ç†±å¸¯", prefer: "flat" },
        { id: "whole", n: 6, name: "å…¨éŸ³éŸ³éš", intervals: [0, 2, 4, 6, 8, 10], region: "ä»", img: "å¤¢å¹»", prefer: "sharp" },
        { id: "mystic", n: 6, name: "ç¥ç§˜éŸ³éš", intervals: [0, 2, 4, 6, 9, 10], region: "ãƒ­ã‚·ã‚¢", img: "æ³•æ‚¦", prefer: "sharp" },
        { id: "blue", n: 6, name: "ãƒ–ãƒ«ãƒ¼ãƒãƒ¼ãƒˆ", intervals: [0, 3, 5, 6, 7, 10], region: "ç±³å›½", img: "é‡æ€§å‘³", prefer: "flat" },
        { id: "ionian", n: 7, name: "ã‚¢ã‚¤ã‚ªãƒ‹ã‚¢ãƒ³", intervals: [0, 2, 4, 5, 7, 9, 11], region: "æ¬§å·", img: "ç¾å®Ÿ", prefer: "sharp" },
        { id: "lydian", n: 7, name: "ãƒªãƒ‡ã‚£ã‚¢ãƒ³", intervals: [0, 2, 4, 6, 7, 9, 11], region: "æ¬§å·", img: "ç¥è©±çš„", prefer: "sharp" },
        { id: "mixo", n: 7, name: "ãƒŸã‚¯ã‚½ãƒªãƒ‡ã‚£ã‚¢ãƒ³", intervals: [0, 2, 4, 5, 7, 9, 10], region: "æ¬§å·", img: "ç¥ç¥­", prefer: "flat" },
        { id: "dorian", n: 7, name: "ãƒ‰ãƒªã‚¢ãƒ³", intervals: [0, 2, 3, 5, 7, 9, 10], region: "æ¬§å·", img: "æ°—é«˜ã„", prefer: "flat" },
        { id: "aeolian", n: 7, name: "ã‚¨ã‚ªãƒªã‚¢ãƒ³", intervals: [0, 2, 3, 5, 7, 8, 10], region: "æ¬§å·", img: "å­¤ç‹¬", prefer: "flat" },
        { id: "phrygian", n: 7, name: "ãƒ•ãƒªã‚¸ã‚¢ãƒ³", intervals: [0, 1, 3, 5, 7, 8, 10], region: "è¥¿å›½", img: "å®¿å‘½", prefer: "flat" },
        { id: "locrian", n: 7, name: "ãƒ­ã‚¯ãƒªã‚¢ãƒ³", intervals: [0, 1, 3, 5, 6, 8, 10], region: "ç¾ä»£", img: "å´©å£Š", prefer: "flat" },
        { id: "phrygian_dom", n: 7, name: "ãƒ•ãƒªã‚¸ã‚¢ãƒ³Dom", intervals: [0, 1, 4, 5, 7, 8, 10], region: "ã‚¨ã‚¸ãƒ—ãƒˆ", img: "å¨åœ§", prefer: "flat" },
        { id: "double_har", n: 7, name: "ãƒ€ãƒ–ãƒ«ãƒãƒ¼ãƒ¢ãƒ‹ãƒƒã‚¯", intervals: [0, 1, 4, 5, 7, 8, 11], region: "ã‚¤ãƒ³ãƒ‰", img: "å®—æ•™", prefer: "flat" },
        { id: "hungary", n: 7, name: "ãƒãƒ³ã‚¬ãƒªãƒ¼çŸ­", intervals: [0, 2, 3, 6, 7, 8, 11], region: "æ±æ¬§", img: "ç‹‚æ°—", prefer: "sharp" },
        { id: "lydian_aug", n: 7, name: "ãƒªãƒ‡ã‚£ã‚¢ãƒ³Aug", intervals: [0, 2, 4, 6, 8, 9, 11], region: "ç¾ä»£", img: "æ™‚ç©ºæ­ª", prefer: "sharp" },
        { id: "lydian_dom", n: 7, name: "ãƒªãƒ‡ã‚£ã‚¢ãƒ³Dom", intervals: [0, 2, 4, 6, 7, 9, 10], region: "ç¾ä»£", img: "ãƒ¢ãƒ€ãƒ³", prefer: "flat" },
        { id: "ultra_loc", n: 7, name: "ã‚¦ãƒ«ãƒˆãƒ©ãƒ­ã‚¯ãƒªã‚¢ãƒ³", intervals: [0, 1, 3, 4, 6, 8, 9], region: "ç¾ä»£", img: "æ·±æ·µ", prefer: "flat" },
        { id: "messiaen2", n: 8, name: "ãƒ¡ã‚·ã‚¢ãƒ³ç¬¬2", intervals: [0, 1, 3, 4, 6, 7, 9, 10], region: "ç¾ä»£", img: "å®çŸ³", prefer: "flat" },
        { id: "messiaen3", n: 9, name: "ãƒ¡ã‚·ã‚¢ãƒ³ç¬¬3", intervals: [0, 2, 3, 4, 6, 7, 8, 10, 11], region: "ç¾ä»£", img: "çˆ†ç™º", prefer: "sharp" },
        { id: "messiaen7", n: 10, name: "ãƒ¡ã‚·ã‚¢ãƒ³ç¬¬7", intervals: [0, 1, 2, 3, 5, 6, 7, 8, 9, 11], region: "ç¾ä»£", img: "ã‚«ã‚ªã‚¹", prefer: "sharp" },
        { id: "scale11", n: 11, name: "11éŸ³æ—‹æ³•", intervals: [0, 1, 2, 4, 5, 6, 7, 8, 9, 10, 11], region: "ç¾ä»£", img: "é£½å’Œ", prefer: "sharp" },
        { id: "spiral", n: "ç‰¹æ®Š", name: "èºæ—‹éŸ³éš", intervals: [0, 2, 4, 6, 8, 10, 13, 15, 17, 19, 21, 23], region: "æ•°å­¦", img: "ç„¡é™ä¸Šæ˜‡", prefer: "sharp" }
    ];

    let currentProjectName = "My New Sonata";
    let allProjects = { "My New Sonata": [] };

    function calculateTotal() {
        let totalSec = 0;
        document.querySelectorAll('.timeline-item').forEach(item => {
            const bars = parseFloat(item.querySelector('.input-bars').value) || 0;
            const bpm = parseFloat(item.querySelector('.input-bpm').value) || 120;
            const sec = (bars * 4) * (60 / bpm);
            item.querySelector('.duration-cell').innerText = Math.round(sec) + "s";
            totalSec += sec;
        });
        const m = Math.floor(totalSec / 60);
        const s = Math.round(totalSec % 60);
        document.getElementById('totalDisplay').innerText = `ç·æ¼”å¥æ™‚é–“: ${m}åˆ† ${s}ç§’`;
    }

    function saveToLocal() {
        const data = [];
        document.querySelectorAll('.timeline-item').forEach(item => {
            data.push({
                bars: item.querySelector('.input-bars').value,
                bpm: item.querySelector('.input-bpm').value,
                secName: item.querySelector('.input-sec').value,
                scale: item.querySelector('.select-scale').value,
                memo: item.querySelector('.input-memo').value
            });
        });
        allProjects[currentProjectName] = data;
        localStorage.setItem('sonataProjectsV2', JSON.stringify(allProjects));
        localStorage.setItem('lastProjectNameV2', currentProjectName);
        document.getElementById('saveStatus').innerText = "ä¿å­˜æ¸ˆã¿ " + new Date().toLocaleTimeString();
    }

    function createNewProject() {
        const name = prompt("æ–°ã—ã„æ›²å:", "Untitled");
        if (name && !allProjects[name]) {
            allProjects[name] = [];
            currentProjectName = name;
            renderProjectList();
            document.getElementById('timeline').innerHTML = "";
            addTimelineRow("64", "120", "æç¤ºéƒ¨", "ç‰çƒéŸ³éš", "");
            saveToLocal();
        }
    }

    function switchProject() {
        currentProjectName = document.getElementById('projectList').value;
        document.getElementById('timeline').innerHTML = "";
        const data = allProjects[currentProjectName];
        if (data && data.length > 0) {
            data.forEach(d => addTimelineRow(d.bars, d.bpm, d.secName, d.scale, d.memo));
        } else {
            addTimelineRow("64", "120", "æç¤ºéƒ¨", "ç‰çƒéŸ³éš", "");
        }
        calculateTotal();
    }

    function renameProject() {
        const newName = prompt("æ›²åå¤‰æ›´:", currentProjectName);
        if (newName && newName !== currentProjectName) {
            allProjects[newName] = allProjects[currentProjectName];
            delete allProjects[currentProjectName];
            currentProjectName = newName;
            renderProjectList(); saveToLocal();
        }
    }

    function deleteProject() {
        if (Object.keys(allProjects).length <= 1) return;
        if (confirm(`ã€Œ${currentProjectName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
            delete allProjects[currentProjectName];
            currentProjectName = Object.keys(allProjects)[0];
            renderProjectList(); switchProject(); saveToLocal();
        }
    }

    function renderProjectList() {
        const list = document.getElementById('projectList');
        list.innerHTML = "";
        Object.keys(allProjects).forEach(name => {
            const opt = document.createElement('option');
            opt.value = name; opt.textContent = name;
            if (name === currentProjectName) opt.selected = true;
            list.appendChild(opt);
        });
    }

    function addTimelineRow(bars="32", bpm="120", secName="", scaleName="ç‰çƒéŸ³éš", memo="") {
        const container = document.getElementById('timeline');
        const div = document.createElement('div');
        div.className = 'timeline-item';
        div.innerHTML = `
            <input type="number" class="input-bars" value="${bars}" oninput="calculateTotal(); saveToLocal();">
            <input type="number" class="input-bpm" value="${bpm}" oninput="calculateTotal(); saveToLocal();">
            <input type="text" class="input-sec" value="${secName}" oninput="saveToLocal();" placeholder="ã‚»ã‚¯ã‚·ãƒ§ãƒ³å">
            <select class="select-scale" onchange="saveToLocal();">
                ${scales.map(s => `<option ${s.name===scaleName?'selected':''}>${s.name}</option>`).join('')}
            </select>
            <input type="text" class="input-memo" value="${memo}" oninput="saveToLocal();" placeholder="ãƒ¡ãƒ¢">
            <div class="duration-cell">0s</div>
            <button class="del-btn" onclick="this.parentElement.remove(); calculateTotal(); saveToLocal();">Ã—</button>
        `;
        container.appendChild(div);
        calculateTotal();
    }

    const keySelect = document.getElementById('keySelect');
    notesFlat.forEach((n, i) => { const opt = document.createElement('option'); opt.value = i; opt.textContent = n; keySelect.appendChild(opt); });
    const checkboxContainer = document.getElementById('checkboxContainer');
    scales.forEach(s => { checkboxContainer.innerHTML += `<label style="font-size:0.7rem; background:#eee; padding:2px 8px; border-radius:10px;"><input type="checkbox" id="check_${s.id}" checked onchange="update()"> ${s.name}</label>`; });

    function update() {
        const shift = parseInt(keySelect.value);
        const order = document.getElementById('orderSelect').value;
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = "";
        const flatKeys = [1, 3, 5, 8, 10];
        const isFlatKey = flatKeys.includes(shift);
        scales.forEach(s => {
            if (!document.getElementById(`check_${s.id}`).checked) return;
            const noteList = (s.prefer === "flat") || (isFlatKey && s.prefer !== "sharp") ? notesFlat : notesSharp;
            let displayIntervals = [...s.intervals];
            if (order === "tertial") {
                let tertial = []; let temp = [...s.intervals]; let i = 0;
                while (temp.length > 0) { tertial.push(temp[i]); temp.splice(i, 1); if (temp.length > 0) i = (i + 1) % temp.length; }
                displayIntervals = tertial;
            }
            tbody.innerHTML += `<tr><td>${s.n}</td><td>${s.name}</td><td class="notes-text">${displayIntervals.map(i => noteList[(i + shift) % 12]).join(" ")}</td><td>${s.region}</td><td>${s.img}</td></tr>`;
        });
    }

    window.onload = () => {
        const savedProjects = localStorage.getItem('sonataProjectsV2');
        const lastProject = localStorage.getItem('lastProjectNameV2');
        if (savedProjects) {
            allProjects = JSON.parse(savedProjects);
            if (lastProject && allProjects[lastProject]) currentProjectName = lastProject;
            else currentProjectName = Object.keys(allProjects)[0];
        }
        renderProjectList(); switchProject(); update();
    };
</script>
</body>
</html>
